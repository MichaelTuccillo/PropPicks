<div class="page">
  <mat-card class="panel">
    <h2 class="h">Parameters</h2>

    <!-- Sport -->
    <div class="row">
      <mat-form-field appearance="outline" class="full compact">
        <mat-label>Sport*</mat-label>
        <mat-select [value]="sport()" (valueChange)="setSport($event)">
          <mat-option *ngFor="let s of sports" [value]="s">{{ s }}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Games (range within next 7 days) -->
    <div class="row games-section" *ngIf="sport()">
      <div class="full">
        <div class="models-head with-bottom-gap">
          <h3 class="sub">Games</h3>
        </div>

        <!-- Date filters + controls -->
        <div class="day-filters compact">
          <mat-form-field appearance="outline" class="day-filter compact">
            <mat-label>From</mat-label>
            <mat-select [value]="startOffset()" (valueChange)="setStartOffset($event)">
              <mat-option *ngFor="let opt of dayChoices(); trackBy: trackChoice" [value]="opt.value">
                {{ opt.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="day-filter compact">
            <mat-label>To</mat-label>
            <mat-select [value]="endOffset()" (valueChange)="setEndOffset($event)">
              <mat-option *ngFor="let opt of dayChoices(); trackBy: trackChoice"
                          [value]="opt.value" [disabled]="opt.value < startOffset()">
                {{ opt.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <div class="day-controls">
            <a class="ghost-btn" (click)="loadGames()">Refresh</a>
            <a class="ghost-btn" (click)="selectAllVisible()" *ngIf="groupedGames()?.length">Select all</a>
            <a class="ghost-btn" (click)="clearVisible()" *ngIf="groupedGames()?.length">Clear</a>
          </div>
        </div>

        <div *ngIf="gamesLoading()" class="muted">Loading games…</div>
        <div *ngIf="gamesError()" class="muted" style="color:#f88;">{{ gamesError() }}</div>

        <ng-container *ngIf="!gamesLoading() && groupedGames()?.length">
          <div class="game-day" *ngFor="let day of groupedGames(); trackBy: trackDay">
            <div class="day-head compact-gap">
              <div class="day-title">{{ day.label }}</div>
              <div class="day-actions">
                <a (click)="selectDay(day.dateKey)">Select day</a>
                <a (click)="clearDay(day.dateKey)">Clear day</a>
              </div>
            </div>

            <div class="game-grid">
              <label class="game-row" *ngFor="let g of day.items; trackBy: trackGame">
                <mat-checkbox
                  [checked]="selectedGameIds().has(g.id)"
                  (change)="toggleGame(g.id, $event.checked)">
                </mat-checkbox>

                <div class="teams">
                  <span class="away">{{ g.away }}</span>
                  <span class="at">@</span>
                  <span class="home">{{ g.home }}</span>
                </div>

                <div class="time">{{ formatTime(g.start) }}</div>
              </label>
            </div>
          </div>
        </ng-container>

        <div class="muted" *ngIf="!gamesLoading() && !groupedGames()?.length">
          No games in the selected window for {{ sport() }}.
        </div>
      </div>
    </div>

    <!-- Bet type + inline Legs -->
    <div class="row">
      <div class="full">
        <label class="field-label">Bet type</label>
        <div class="bettype-inline">
          <mat-button-toggle-group [value]="mode()" (valueChange)="setMode($event)">
            <mat-button-toggle value="Single">Single</mat-button-toggle>
            <mat-button-toggle value="SGP">SGP</mat-button-toggle>
            <mat-button-toggle value="SGP+">SGP+</mat-button-toggle>
          </mat-button-toggle-group>

          <!-- Legs input shown only for SGP / SGP+; min 2 -->
          <mat-form-field appearance="outline" class="legs-inline compact" *ngIf="mode()!=='Single'">
            <mat-label>Legs</mat-label>
            <input
              matInput
              type="number"
              [attr.min]="2"
              step="1"
              [value]="legs()"
              (input)="onLegsInput($event)"
            >
          </mat-form-field>
        </div>
      </div>
    </div>

    <!-- Presets -->
    <div class="row presets-inline">
      <span class="muted">Presets:</span>
      <button mat-stroked-button class="preset-btn" (click)="setPreset('safe')">Safe</button>
      <button mat-stroked-button class="preset-btn" (click)="setPreset('balanced')">Balanced</button>
      <button mat-stroked-button color="primary" class="preset-btn" (click)="setPreset('longshot')">Longshot</button>
    </div>

    <!-- Odds -->
    <div class="row">
      <mat-form-field appearance="outline" class="half compact">
        <mat-label>Min odds (American)</mat-label>
        <input
          matInput
          type="number"
          [attr.step]="5"
          [value]="minOddsText()"
          (input)="onOddsInput('min', $event)"
          (blur)="onOddsBlur('min', $event)"
        />
        <mat-error *ngIf="oddsInvalid('min')">Odds cannot be between −100 and +100.</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="half compact">
        <mat-label>Max odds (American)</mat-label>
        <input
          matInput
          type="number"
          [attr.step]="5"
          [value]="maxOddsText()"
          (input)="onOddsInput('max', $event)"
          (blur)="onOddsBlur('max', $event)"
        />
        <mat-error *ngIf="oddsInvalid('max')">Odds cannot be between −100 and +100.</mat-error>
      </mat-form-field>
    </div>

    <!-- Models (single-select) -->
    <div class="row models-head with-bottom-gap">
      <h3 class="sub">Models</h3>
      <div class="actions">
        <a (click)="clearModels()">Clear</a>
      </div>
    </div>

    <div class="row checks compact-gap">
      <label class="check" *ngFor="let m of models(); trackBy: trackModel">
        <mat-checkbox
          [checked]="selectedIds().has(m.id)"
          (change)="setExclusiveModel(m.id, $event.checked)">
        </mat-checkbox>

        <span class="model-label">
          {{ m.name }}
          <mat-icon
            class="info"
            [matTooltip]="getModelDesc(m)"
            matTooltipClass="model-tip"
            [matTooltipPosition]="'above'"
            matTooltipShowDelay="150"
            matTooltipHideDelay="0"
            (click)="$event.stopPropagation()"
            (mousedown)="$event.stopPropagation()"
            (touchstart)="$event.stopPropagation()"
            aria-label="Model info"
            tabindex="0"
          >info</mat-icon>
        </span>
      </label>
    </div>

    <div class="cta-row">
      <div class="hint muted" *ngIf="!canGenerate()">
        Select exactly one model, pick <strong>at least one game</strong>, and enter valid odds (no values between −100 and +100).
      </div>

      <button mat-stroked-button class="clear-btn small" (click)="clearResults()" *ngIf="slipsOut()">
        <mat-icon>clear</mat-icon>
        Clear
      </button>

      <button
        mat-raised-button
        color="primary"
        class="generate-btn small"
        [disabled]="aiLoading() || !canGenerate()"
        (click)="generateAiSlip()">
        <mat-icon>auto_awesome</mat-icon>
        Generate bets
      </button>
      <span *ngIf="aiLoading()" class="hint">Generating…</span>
      <span *ngIf="aiError()" class="hint" style="color:#f88;">{{ aiError() }}</span>
    </div>
  </mat-card>

  <!-- AI result with editable odds + editable stake + Save/Discard -->
  <mat-card class="panel" *ngIf="aiSlip() as s">
    <div class="results">
      <h3 class="sub">AI Bet Slip</h3>
      <div class="slip">
        <div class="head">
          {{ s.title || 'Proposed Bet Slip' }}
        </div>
        <div class="muted" *ngIf="s.event">{{ s.event }}</div>

        <ul class="legs">
          <li *ngFor="let l of s.legs">
            <strong>{{ l.market }}:</strong> {{ l.pick }}
            <span *ngIf="l.line || l.odds">
              (<ng-container *ngIf="l.line">Line: {{ l.line }}</ng-container>
               <ng-container *ngIf="l.line && l.odds"> • </ng-container>
               <ng-container *ngIf="l.odds">Odds: {{ l.odds }}</ng-container>)
            </span>
            <div class="muted" *ngIf="l.notes">{{ l.notes }}</div>
          </li>
        </ul>

        <!-- Editable odds + stake (same behavior as filter odds; stake > 0) -->
        <div class="edit-odds">
          <mat-form-field appearance="outline" class="half compact" *ngIf="mode()==='Single'">
            <mat-label>Odds (American)</mat-label>
            <input
              matInput
              type="text"
              [attr.step]="5"
              [value]="editableOdds()"
              (input)="onSlipOddsInput($event)"
              (blur)="onSlipOddsBlur($event)"
            >
          </mat-form-field>

          <mat-form-field appearance="outline" class="half compact" *ngIf="mode()!=='Single'">
            <mat-label>Total odds (American)</mat-label>
            <input
              matInput
              type="text"
              [attr.step]="5"
              [value]="editableOdds()"
              (input)="onSlipOddsInput($event)"
              (blur)="onSlipOddsBlur($event)"
            >
          </mat-form-field>

          <mat-form-field appearance="outline" class="half compact">
            <mat-label>Stake (units)</mat-label>
            <input
              matInput
              type="text"
              [value]="unitsText()"
              (input)="onUnitsInput($event)"
              (blur)="onUnitsBlur($event)"
            >
          </mat-form-field>
        </div>

        <div class="why" *ngIf="s.rationale">
          <div class="muted">Why:</div>
          <div>{{ s.rationale }}</div>
        </div>
      </div>

      <div class="right-actions" style="margin-top:8px;">
        <button mat-stroked-button color="warn" (click)="discardAiSlip()">Discard</button>
        <button mat-raised-button color="primary" (click)="saveAiSlip()">Save</button>
      </div>
    </div>
  </mat-card>
</div>
